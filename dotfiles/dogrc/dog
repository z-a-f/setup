#!/usr/bin/env perl

use warnings;
use strict;

#use HTML::TagParser;
use Term::ANSIColor;

use vars qw/ %opt %lang $FH $filename $extension %CONFIG /;

use Data::Dumper; #Debug

my $DOGPATH = $ENV{"HOME"} . "/setup/dotfiles/dogrc";
# our %CONFIG;
# require "$DOGPATH/.dogrc";

#######################################
# Command line processing
#######################################
sub init () {
    use Getopt::Std;
    my $opt_string = 'hx:';
    getopts("$opt_string", \%opt) or help();
    help() if $opt{h};
    return getNames();
}

#######################################
# Help
#######################################
sub help() {
    print STDERR << "EOF";
NAME
    dog - prints the file to standatd output with source highlighting

SYNOPSIS
    dog [OPTION] [FILE]

DESCRIPTION
    -n
    	Show line numbers
    -x LANGUAGE
    	Specify explicitly the language fi the following input files (rather than letting the compiler choose a default based on the file name suffix). Possible values for LANGUAGE are:
    <TODO: Language list>

EOF
    exit;
}

#######################################
# Get the names
#######################################
sub getNames() {
    if (! $ARGV[0]) {
	die "No file to open, $!";
    }
    my $fname = $ARGV[0];
    my ($ext) = $fname =~ /(\.[^.]+)$/;
    open my $fh, '<', $fname or die "Cannot open file $fname, $!";
    return ($fh, $fname, $ext);
}

#######################################
# Open configuration and set the language
#######################################

sub config() {

    if (!$extension && !$opt{x}) {
	# If no explicit language + no extension
	cat();
	exit;
    } else {
	# return language($conf_fh);
	# print Dumper($CONFIG{'LANGS'});
	%CONFIG = do './.dogrc';
	# print Dumper(\%CONFIG);
    }
    
    # See if language list exists:
    foreach my $key1 (%CONFIG) {
	if ($key1 eq "LANGS") {
	    # print "LANGS found \n";
	    # print $CONFIG{$key};
	    foreach my $key2 (%{$CONFIG{$key1}}) {
		if ($key2 eq $opt{x}) {
		    # print "$opt{x} found\n";
		} else {
		    die "Explicitely defined language '$opt{x}' not found in the configuration, $!";
		}
	    }
	}
    }
    return 0;
}

#######################################
# CAT
#######################################
sub cat() {
    #open (FILE, "<$filename") or die "Cannot open file $filename, $!";
    print colored ("#######################################\n", 'green');
    print colored ("# Cannot identify language...\n", 'green');
    print colored ("#######################################\n", 'green');
    while (<$FH>) {
	print "$_";
    }
    print colored ("#######################################\n", 'green');
}


#######################################
# Main
#######################################
($FH, $filename, $extension) = init();
print config();

#print $filename . "\n";
#print $extension . "\n";
